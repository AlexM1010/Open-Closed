# Open-Closed Architecture

## System Overview

Open-Closed is a dual-platform life management system built on Structural Optimism principles. It consists of two applications that work together through a hub-and-spoke architecture.

```
┌─────────────────────────────────────────────────────────────────┐
│              Life Manager (Web) - Intelligence Hub               │
│                                                                  │
│  Aggregates data from multiple sources:                         │
│  • Google Tasks & Calendar                                      │
│  • Todoist (planned)                                            │
│  • Google Fit (planned)                                         │
│                                                                  │
│  Responsibilities:                                              │
│  • Pull data from all integrations                             │
│  • Store historical data in SQLite                             │
│  • Run planning algorithm with smart time-blocking             │
│  • Generate analytics, streaks, guardrails                     │
│  • Export daily plan to Google Calendar                        │
│  • Energy level input (start of day ritual)                    │
│  • Read completion/skip/snooze status from calendar            │
│  • Celebration when tasks completed                            │
└──────────────┬──────────────────────────────────────────────────┘
               │
               │ Exports plan ↓ Reads status ↑
               ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Google Calendar                               │
│                  (Shared Source of Truth)                        │
│                                                                  │
│  "Life Manager - Today's Plan" calendar:                        │
│  • Tasks time-blocked into gaps between meetings               │
│  • Each event has Status: pending|completed|skipped|snoozed    │
│  • Launcher updates status, Manager reads it back              │
│                                                                  │
│  Primary calendar (user's events):                             │
│  • Life Manager reads to find gaps for time-blocking           │
│  • Launcher shows events with progressive urgency              │
└──────────────┬──────────────────────────────────────────────────┘
               │
               │ Reads plan ↓ Updates status ↑
               ▼
┌─────────────────────────────────────────────────────────────────┐
│            Life Launcher (Android) - Simple Display              │
│                                                                  │
│  Responsibilities:                                              │
│  • Show tasks from "Today's Plan" calendar                     │
│  • Show calendar events (progressive: 45min → 15min → now)     │
│  • Three gestures: complete, skip, snooze-to-tomorrow          │
│  • Skip-cycling: skipped tasks rotate, show shorter next       │
│  • Update event status in calendar                             │
│  • Direct to web app when tasks exhausted                      │
│                                                                  │
│  NOT responsible for:                                           │
│  • Energy input (done in web app)                              │
│  • Planning algorithm (done in web app)                        │
│  • Analytics (done in web app)                                 │
└─────────────────────────────────────────────────────────────────┘
```

## Design Philosophy

### Separation of Concerns

**Life Manager (Web)** = Intelligence Layer
- Complex data aggregation
- Multi-source integration
- Smart time-blocking (fits tasks into calendar gaps)
- Historical analytics
- Planning algorithm
- Desktop-friendly stats dashboard
- Energy input and plan generation

**Life Launcher (Android)** = Interaction Layer
- Simple, glanceable interface
- Quick task completion with gestures
- Skip-cycling (skip → easiest task, complete → back to hardest)
- Progressive user event display (45min → 15min → takeover)
- No complex logic
- Works offline with cached data
- Directs to web app for more tasks

### Why This Architecture?

1. **Scalability**: Add new integrations to life-manager without touching launcher
2. **Simplicity**: Launcher stays lightweight and fast
3. **Flexibility**: Users can use just launcher, just manager, or both
4. **Reliability**: Google Calendar provides offline access and sync
5. **Privacy**: Each user's data stays in their own Google account

## Data Flow

### Three Types of Items

1. **Tasks** - Raw to-do items from Google Tasks, Todoist (not time-blocked)
2. **User Events** - Meetings/appointments manually added to Google Calendar
3. **Task Events** - Auto-generated by Life Manager (tasks → time-blocked calendar events)

### Daily Planning Flow

```
1. User opens Life Manager web app
   ↓
2. Sets energy level (0-10) for the day
   ↓
3. Life Manager shows:
   - Today's user events (meetings)
   - Suggested tasks (sorted by urgency + domain balance)
   - All pending tasks (scroll down)
   ↓
4. User picks tasks for today + adds time estimates
   ↓
5. Smart time-blocking:
   - Find gaps between user events
   - Slot selected tasks into gaps (hardest first)
   - 5-min buffer before meetings
   ↓
6. Export to "Life Manager - Today's Plan" calendar:
   - Each task → task event with metadata
   - Status: pending (initial state)
   ↓
7. Life Launcher reads task events from calendar
   - Shows next pending task event
   - User works through with gestures
```

### Task Interaction Flow (Life Launcher)

```
┌─────────────────────────────────────────────────────────────┐
│                    GESTURE ACTIONS                          │
├─────────────────────────────────────────────────────────────┤
│  Swipe RIGHT  →  Complete                                   │
│                  • Status: completed                        │
│                  • CompletedAt: timestamp                   │
│                  • Remove from cycle, show next             │
├─────────────────────────────────────────────────────────────┤
│  Swipe LEFT   →  Skip (stays in cycle)                      │
│                  • Jump to easiest task (back of queue)     │
│                  • Complete easy → return to hardest        │
│                  • Cycles until completed or snoozed        │
├─────────────────────────────────────────────────────────────┤
│  Swipe DOWN   →  Snooze to tomorrow                         │
│                  • Status: snoozed                          │
│                  • SnoozedTo: tomorrow's date               │
│                  • Remove from cycle entirely               │
│                  • Life Manager reschedules next day        │
└─────────────────────────────────────────────────────────────┘
```

### Event Display Flow (Life Launcher)

Widget always shows **task events** (from "Today's Plan" calendar).
**User events** (meetings from primary calendar) appear progressively:

```
Time until user event   Widget shows
─────────────────────────────────────────────────────────────
> 45 min                Task event only
15-45 min               Task event + user event preview below
< 15 min                User event takes over
─────────────────────────────────────────────────────────────

User can complete/skip user event to return to task events.
Status added to user event (not deleted).
```

### Widget Tap Behavior

| Widget State | Tap Action |
|--------------|------------|
| Showing task | Open Life Manager web app |
| Showing "Need More Tasks" | Open Life Manager web app |
| Showing event | Open event link (Zoom, Meet, Maps) |
| No tasks, no events | Open Google Calendar for today |

### Completion Sync Flow

```
User completes/skips/snoozes task in Launcher
   ↓
Launcher updates calendar event description:
   Status: completed|skipped|snoozed
   CompletedAt/SkippedAt/SnoozedAt: timestamp
   SnoozedTo: date (if snoozed)
   ↓
Google Calendar syncs (automatic)
   ↓
Life Manager reads status on next sync:
   - Completions → task_completions table
   - Skips → task_skips table (for analytics)
   - Snoozes → reschedule task for snoozed date
   ↓
Domain balance recalculated for next plan
```

## Task Encoding Convention

Both applications understand tasks through a shared encoding format:

```
Event Title Format:
[!!!] Call Mom (15m)
 │     │        │
 │     │        └── Duration in minutes
 │     └── Task title
 └── Priority: [!!!]=must-do, [!!]=should-do, [!]=nice-to-have

Event Description Format:
Domain: Relationships
Task ID: 42
Category: must-do
Status: pending
```

**Status Values:**
- `pending` - Not yet acted on (default)
- `completed` - User swiped right
- `skipped` - User swiped left (tracked for analytics, but task cycles)
- `snoozed` - User swiped down (rescheduled to SnoozedTo date)

## Smart Time-Blocking

Life Manager reads the user's primary calendar and slots tasks into gaps:

```
User's calendar:                    Life Manager exports:
─────────────────────────────────────────────────────────────
09:00-10:00  Team standup           
                                    10:00-10:15  [!!!] Call Mom (15m)
                                    10:15-10:45  [!!] Pay bills (30m)
                                    10:50-10:55  Buffer before meeting
11:00-12:00  Client call            
                                    12:00-12:30  [!] Go for walk (30m)
12:30-13:30  Lunch with Sarah       
                                    13:30-14:00  [!!] Review docs (30m)
```

**Rules:**
- Minimum gap: 10 minutes
- Buffer before meetings: 5 minutes
- All-day events: Ignored (don't block time)
- Tasks that don't fit: Scheduled at end of day

## Planning Algorithm

The algorithm is deterministic and runs in Life Manager:

**Inputs:**
- Tasks from all sources (Google Tasks, etc.)
- User's calendar events (for time-blocking)
- Completions/skips in last 7 days (from SQLite)
- Current energy level (from web app input)
- Current date and time

**Algorithm:**
1. Read user's calendar, find gaps
2. Aggregate tasks from all sources
3. Filter by energy-based duration cap
4. Score each task:
   ```
   score = priority_weight 
         + domain_neglect_bonus 
         + overdue_bonus
   ```
5. Slot top N tasks into calendar gaps
6. Export to "Life Manager - Today's Plan" calendar

**Energy Configuration:**
| Energy | Tasks | Duration Cap |
|--------|-------|--------------|
| 0-3    | 2-3   | 15 min max   |
| 4-6    | 3-5   | No cap       |
| 7-10   | 5-6   | No cap       |

## Technology Stack

### Life Manager (Web)
- **Frontend**: React 18 + Vite + Tailwind CSS
- **Backend**: Express + tRPC
- **Database**: SQLite + Drizzle ORM
- **Testing**: Vitest + fast-check
- **APIs**: Google Calendar, Google Tasks

### Life Launcher (Android)
- **Language**: Kotlin
- **UI**: Android Widgets + Custom Views + Gesture Detection
- **APIs**: Google Calendar API (via Play Services)
- **Storage**: SharedPreferences (cache + cycle state)

## Security & Privacy

### Data Storage
- **User data**: Stored in user's own Google account
- **Analytics**: Stored locally in life-manager SQLite
- **No central database**: Each user runs their own life-manager instance
- **OAuth tokens**: Stored securely (Android Keystore / server environment)

### Privacy Principles
1. User owns their data (in their Google account)
2. Life-manager can be self-hosted
3. No telemetry or tracking
4. Open source (GPLv3)

## Offline Behavior

### Life Launcher
- Caches last fetched plan from Google Calendar
- Shows cached tasks when offline
- Maintains local skip-cycle state
- Queues status updates for sync when back online
- Shows "Offline" indicator

### Life Manager
- Requires internet for integrations
- Can run planning algorithm on cached data
- Syncs when connection restored

## Deployment Options

### Life Manager
1. **Local** (recommended for privacy)
   - Run on user's machine
   - `npm run dev` for development
   - `npm run build && npm start` for production

2. **Self-hosted server**
   - Deploy to personal VPS
   - Railway, Fly.io, or Render

### Life Launcher
- Distributed via APK or Google Play Store
- Each user authenticates with their own Google account
- Reads from their personal Google Calendar

## Future Enhancements

### Planned Features
- [ ] Todoist integration
- [ ] Google Fit integration
- [ ] Domain balance radar chart
- [ ] Weekly review prompt
- [ ] Streak visualization in launcher
- [ ] Voice completion ("Hey Google, mark task complete")

### Architectural Improvements
- [ ] Real-time sync (WebSocket/SSE)
- [ ] Conflict resolution UI
- [ ] Backup/restore functionality

## Development Workflow

### Working on Life Manager
```bash
cd life-manager
npm install
npm run db:migrate
npm run dev
```

### Working on Life Launcher
```bash
cd life-launcher
./gradlew assembleDebug
adb install app/build/outputs/apk/debug/app-debug.apk
```

### Testing Integration
1. Set up Google OAuth credentials
2. Run life-manager locally
3. Set energy level, generate plan
4. Verify tasks appear in Google Calendar with time blocks
5. Open life-launcher on Android
6. Verify tasks appear, test gestures
7. Verify status updates sync back to Life Manager

## Contributing

See individual project READMEs for contribution guidelines:
- [Life Manager Contributing](./life-manager/README.md)
- [Life Launcher Contributing](./life-launcher/README.md)

## License

Both projects are licensed under [GNU GPLv3](https://www.gnu.org/licenses/gpl-3.0.en.html).
